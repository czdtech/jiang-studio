# MCP 提示词优化器集成设计文档

> 创建日期：2026-02-02

## 1. 项目概述

### 1.1 项目定位
自用工具，用于 YouTube/TikTok 创作的 AI 图片生成工作室。

### 1.2 开发优先级
1. **A - MCP 集成优化**（本文档）
2. B - UI 优化
3. C - 批量任务

---

## 2. 整体布局

```
┌─────────────┬──────────────────────┬─────────────────┐
│   左侧栏     │      中间区域         │    右侧栏        │
│  (280px)    │      (自适应)         │ (320px 可拖拽)   │
│             │                      │                 │
│ • Gemini设置 │   生成的图片网格      │   迭代助手       │
│ • 供应商配置 │                      │  (iterate-prompt)│
│ • 优化器设置 │                      │                 │
│   - 开关    │                      │  • 对话历史      │
│   - 手动/自动│                      │  • 输入框       │
│   - 优化按钮 │                      │  • "使用此版本"  │
├─────────────┴──────────────────────┴─────────────────┤
│           提示词输入 + 参数选择 + 生成按钮              │
└──────────────────────────────────────────────────────┘
```

---

## 3. 提示词优化流程（optimize-user-prompt）

### 3.1 触发方式

| 模式 | 触发时机 | 说明 |
|-----|---------|------|
| 手动模式 | 点击"优化"按钮 | 用户主动触发 |
| 自动模式 | 点击"生成"按钮 | 先优化再生图 |

### 3.2 流程图

```
用户输入提示词
      ↓
┌─────────────────────────────────────┐
│  手动模式          │   自动模式      │
│  点"优化"按钮触发   │  点"生成"时触发  │
└─────────────────────────────────────┘
      ↓
调用 MCP: optimize-user-prompt
      ↓
成功 → 直接替换输入框内容
      ↓
失败 → 弹窗询问"优化失败，是否用原始提示词继续？"
```

### 3.3 配置项
- **位置**：左侧"优化器设置"面板
- **控件**：
  - 手动/自动开关
  - 手动模式下的"优化"按钮

---

## 4. 迭代助手（iterate-prompt）

### 4.1 界面结构

```
┌─────────────────────────┐
│  💬 迭代助手            │  ← 标题栏
├─────────────────────────┤
│                         │
│  用户: 我想要更可爱的猫   │  ← 对话区域
│                         │
│  AI: 一只毛茸茸的小猫... │
│  [使用此版本]            │  ← 每条回复下有按钮
│                         │
│  用户: 再加点阳光        │
│                         │
│  AI: 一只毛茸茸的小猫... │
│  [使用此版本]            │
│                         │
├─────────────────────────┤
│ [输入你的需求...]  [发送] │  ← 输入区
└─────────────────────────┘
```

### 4.2 交互流程

```
用户输入需求（如"我想要更可爱"）
      ↓
调用 MCP: iterate-prompt
      ↓
AI 返回优化后的提示词
      ↓
用户点"使用此版本" → 填入底部提示词输入框（不自动生图）
```

### 4.3 特性
- 宽度默认 320px，可拖拽调整
- 对话历史不保存，关闭页面清空
- 始终显示在右侧

---

## 5. MCP 集成技术方案

### 5.1 依赖安装

```bash
pnpm add @modelcontextprotocol/sdk
```

### 5.2 服务封装

```typescript
// services/mcp.ts
import { Client } from '@modelcontextprotocol/sdk/client/index.js';
import { StreamableHTTPClientTransport } from '@modelcontextprotocol/sdk/client/streamableHttp.js';

const MCP_URL = 'http://localhost:8081/mcp';

// 优化用户提示词（生图用）
async function optimizeUserPrompt(prompt: string): Promise<string>

// 迭代提示词（迭代助手用）
async function iteratePrompt(prompt: string, requirement: string): Promise<string>
```

### 5.3 调用地址
- Docker 部署：`http://localhost:8081/mcp`

### 5.4 错误处理
- 连接失败 / 超时 → 弹窗询问是否用原始提示词

---

## 6. UI 调整汇总

### 6.1 左侧栏变更

| 原有 | 变更 |
|-----|------|
| 优化器设置面板 | 新增：手动/自动开关 |
| - | 新增：手动模式下的"优化"按钮 |
| 输入框旁的"增强"按钮 | **移除** |
| 输入框旁的模型选择 | **移除** |

### 6.2 新增右侧栏
- 迭代助手对话窗口
- 宽度 320px，可拖拽
- 始终显示

### 6.3 底部区域
- 保持不变（提示词输入 + 参数 + 生成按钮）

---

## 7. 开发任务清单

| 序号 | 任务 | 说明 |
|-----|------|------|
| 1 | 安装 MCP SDK | `@modelcontextprotocol/sdk` |
| 2 | 创建 MCP 服务封装 | `services/mcp.ts` |
| 3 | 改造优化器设置面板 | 添加手动/自动开关 + 优化按钮 |
| 4 | 移除旧的优化按钮 | 删除输入框旁的"增强"按钮和模型选择 |
| 5 | 修改生成流程 | 自动模式下先优化再生图 |
| 6 | 新建迭代助手组件 | 右侧对话窗口 |
| 7 | 实现拖拽调整宽度 | 右侧栏支持拖拽 |
| 8 | 集成到主布局 | 三栏布局调整 |

---

## 8. 决策记录

| 编号 | 决策项 | 决策结果 |
|-----|--------|---------|
| 1 | 项目定位 | 自用工具（YouTube/TikTok 创作） |
| 2 | 开发优先级 | A(集成优化) → B(UI优化) → C(批量任务) |
| 3 | 优化触发方式 | 手动/自动可切换，开关在左侧设置面板 |
| 4 | 自动模式行为 | 点生成时先优化再生图 |
| 5 | 优化结果处理 | 直接替换原提示词 |
| 6 | 失败处理 | 弹窗询问是否继续 |
| 7 | MCP SDK | 使用 `@modelcontextprotocol/sdk` |
| 8 | 迭代助手位置 | 右侧始终显示，320px 可拖拽 |
| 9 | "使用此版本"按钮 | 每条 AI 回复下都有 |
| 10 | 点击行为 | 只填入，不自动生图 |
| 11 | 对话历史 | 不保存 |
